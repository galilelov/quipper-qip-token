<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Blitz Pro</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #1a1a2e; color: white; display: flex; align-items: center; justify-content: center; height: 100dvh; overflow: hidden; }
        #game-container { width: 100%; max-width: 400px; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        #status-bar { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; color: #00d2ff; }
        #set-info { text-align: center; color: #e94560; font-size: 14px; }
        
        #question-box { min-height: 120px; background: rgba(255,255,255,0.05); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 26px; font-weight: bold; padding: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .bonus-q { font-size: 18px; color: #00d2ff; margin-top: 10px; }

        #timer-area { width: 100%; height: 10px; }
        #timer-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: #e94560; }

        #grid, #bonus-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .cell { aspect-ratio: 1 / 1; background: #16213e; border: 2px solid #0f3460; color: white; font-size: 32px; font-weight: bold; border-radius: 18px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; border: none; outline: none; }
        .cell:active { transform: scale(0.9); background: #0f3460; }
        .comp-btn { font-size: 40px; color: #e94560; border: 2px solid #e94560; background: #1a1a2e; border-radius: 50%; }
        
        .correct { background: #2ecc71 !important; }
        .wrong { background: #e74c3c !important; }

        #start-btn { width: 100%; padding: 25px; font-size: 24px; font-weight: bold; background: #e94560; color: white; border: none; border-radius: 20px; cursor: pointer; box-shadow: 0 10px 20px rgba(233, 69, 96, 0.3); }
        .combo-dots { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .dot { width: 12px; height: 12px; background: #333; border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #00d2ff; box-shadow: 0 0 10px #00d2ff; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-bar">
        <span>üí∞ <b id="tokens">0</b></span>
        <span>‚ù§Ô∏è <b id="lives">18</b></span>
    </div>
    <div id="set-info">
        –°–ï–¢: <span id="progress">0</span> / 9 
        <div id="combo" class="combo-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>

    <div id="question-box">–ó–ê–ì–†–£–ó–ö–ê</div>
    
    <div id="timer-area">
        <div id="timer-container"><div id="timer-bar"></div></div>
    </div>

    <div id="grid">
        <button class="cell" onclick="makeMove(1)">1</button>
        <button class="cell" onclick="makeMove(2)">2</button>
        <button class="cell" onclick="makeMove(3)">3</button>
        <button class="cell" onclick="makeMove(4)">4</button>
        <button class="cell" onclick="makeMove(5)">5</button>
        <button class="cell" onclick="makeMove(6)">6</button>
        <button class="cell" onclick="makeMove(7)">7</button>
        <button class="cell" onclick="makeMove(8)">8</button>
        <button class="cell" onclick="makeMove(9)">9</button>
    </div>

    <div id="bonus-grid">
        <button class="cell comp-btn" onclick="makeBonusMove('<')">&lt;</button>
        <button class="cell comp-btn" onclick="makeBonusMove('=')">=</button>
        <button class="cell comp-btn" onclick="makeBonusMove('>')">&gt;</button>
    </div>

    <button id="start-btn" onclick="startNewSet()">–ù–ê–ß–ê–¢–¨ –°–ï–¢</button>
</div>

<script>
    let tokens = 0, lives = 18, setProgress = 0, combo = 0;
    let currentQuestionIndex = 0;
    let currentAnswer, timer, canClick = false, isBonus = false, bonusStep = 0, bonusAnswer = '';
    let allQuestions = [];

    async function init() {
        try {
            const res = await fetch('questions.json?v=' + Date.now());
            allQuestions = await res.json();
            document.getElementById('question-box').innerText = "–ì–û–¢–û–í";
            document.getElementById('start-btn').style.display = 'block';
        } catch (e) { document.getElementById('question-box').innerText = "–û–®–ò–ë–ö–ê JSON"; }
    }

    function startNewSet() {
        setProgress = 0;
        lives = 18;
        combo = 0;
        isBonus = false;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('grid').style.display = 'grid';
        document.getElementById('bonus-grid').style.display = 'none';
        updateUI();
        nextQuestion();
    }

    function nextQuestion() {
        if (setProgress >= 9) { startBonusRound(); return; }
        
        canClick = false;
        resetStyles();
        
        const q = allQuestions[currentQuestionIndex];
        currentAnswer = q.a;
        
        document.getElementById('question-box').innerText = q.q;
        startTimer(q.t);
        setTimeout(() => { canClick = true; }, 200);
    }

    function makeMove(num) {
        if (!canClick) return;
        const cells = document.querySelectorAll('#grid .cell');
        
        if (num === currentAnswer) {
            clearInterval(timer);
            tokens += 10;
            combo++;
            setProgress++;
            
            if (combo === 3) { tokens += 30; combo = 0; }
            
            cells[num-1].classList.add('correct');
            
            currentQuestionIndex++;
            if (currentQuestionIndex >= allQuestions.length) currentQuestionIndex = 0;

            updateUI();
            setTimeout(nextQuestion, 400);
        } else {
            tokens = Math.max(0, tokens - 1);
            lives--;
            combo = 0;
            cells[num-1].classList.add('wrong');
            updateUI();
            if (lives <= 0) gameOver("–ñ–ò–ó–ù–ò –ö–û–ù–ß–ò–õ–ò–°–¨");
        }
    }

    function startBonusRound() {
        isBonus = true;
        bonusStep = 0;
        document.getElementById('grid').style.display = 'none';
        document.getElementById('bonus-grid').style.display = 'grid';
        nextBonusTask();
    }

    function nextBonusTask() {
        if (bonusStep >= 3) {
            tokens += 1000;
            updateUI();
            alert("–ë–û–ù–£–° 1000 –¢–û–ö–ï–ù–û–í –í–ê–®!");
            startNewSet();
            return;
        }
        
        // –ë–µ—Ä–µ–º –æ–¥–∏–Ω –ª–µ–≥–∫–∏–π (–∏–∑ –Ω–∞—á–∞–ª–∞ –±–∞–∑—ã) –∏ –æ–¥–∏–Ω —Å–ª–æ–∂–Ω—ã–π (–∏–∑ –∫–æ–Ω—Ü–∞ –±–∞–∑—ã)
        const qA = allQuestions[Math.floor(Math.random() * 1000)]; 
        const qB = allQuestions[allQuestions.length - 1 - Math.floor(Math.random() * 1000)];

        if (qA.a < qB.a) bonusAnswer = '<';
        else if (qA.a > qB.a) bonusAnswer = '>';
        else bonusAnswer = '=';

        document.getElementById('question-box').innerHTML = `
            <div style="font-size:16px; color:#00d2ff">–ë–û–ù–£–°–ù–´–ô –¢–£–† ${bonusStep+1}/3</div>
            <div class="bonus-q">${qA.q} <span style="color:#e94560">?</span> ${qB.q}</div>
        `;
        startTimer(9000);
        canClick = true;
    }

    function makeBonusMove(sym) {
        if (!canClick) return;
        if (sym === bonusAnswer) {
            clearInterval(timer);
            bonusStep++;
            nextBonusTask();
        } else {
            alert("–û–®–ò–ë–ö–ê! –ë–û–ù–£–° –ü–û–¢–ï–†–Ø–ù");
            startNewSet();
        }
    }

    function startTimer(duration) {
        clearInterval(timer);
        const bar = document.getElementById('timer-bar');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { 
            bar.style.transition = `width ${duration}ms linear`; 
            bar.style.width = '0%'; 
        }, 50);
        
        timer = setTimeout(() => { 
            if(isBonus) { alert("–í–†–ï–ú–Ø –í–´–®–õ–û!"); startNewSet(); }
            else { 
                lives--; 
                updateUI(); 
                if(lives <= 0) gameOver("–í–†–ï–ú–Ø –í–´–®–õ–û"); 
                else nextQuestion(); 
            }
        }, duration);
    }

    function updateUI() {
        document.getElementById('tokens').innerText = tokens;
        document.getElementById('lives').innerText = lives;
        document.getElementById('progress').innerText = setProgress;
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.className = i < combo ? 'dot active' : 'dot');
    }

    function gameOver(txt) {
        clearInterval(timer);
        canClick = false;
        document.getElementById('question-box').innerText = txt;
        document.getElementById('start-btn').style.display = 'block';
        document.getElementById('start-btn').innerText = "–ü–û–í–¢–û–†–ò–¢–¨ –°–ï–¢";
    }

    function resetStyles() {
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('correct', 'wrong'));
    }

    init();
</script>
</body>
</html>
