<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Blitz Pro</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; background: #1a1a2e; color: white; display: flex; flex-direction: column; align-items: center; height: 100dvh; overflow: hidden; }
        #game-container { width: 100%; max-width: 400px; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 10px; }
        
        #status-bar { display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #00d2ff; }
        #set-info { text-align: center; color: #e94560; font-size: 14px; margin-top: 5px; }
        
        #question-box { font-size: 28px; font-weight: bold; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 15px; margin: 5px 0; text-align: center; padding: 10px; }
        .bonus-q { font-size: 18px; color: #00d2ff; }

        #timer-area { width: 100%; height: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
        #timer-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: #e94560; }

        #grid, #bonus-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        #bonus-grid { display: none; }

        .cell { aspect-ratio: 1 / 1; background: #16213e; border: 2px solid #0f3460; color: white; font-size: 32px; font-weight: bold; cursor: pointer; border-radius: 15px; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
        .cell:active { background: #e94560; transform: scale(0.9); }
        .comp-btn { font-size: 40px; color: #e94560; border-color: #e94560; }

        .correct { background: #2ecc71 !important; border-color: white !important; }
        .wrong { background: #e74c3c !important; }

        #start-btn { width: 100%; padding: 18px; font-size: 22px; font-weight: bold; background: #e94560; color: white; border: none; border-radius: 15px; cursor: pointer; display: none; }
        .combo-dots { display: flex; justify-content: center; gap: 8px; margin-top: 5px; }
        .dot { width: 12px; height: 12px; background: #333; border-radius: 50%; }
        .dot.active { background: #00d2ff; box-shadow: 0 0 10px #00d2ff; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-bar">
        <span>üí∞ <b id="tokens">0</b></span>
        <span>‚ù§Ô∏è <b id="lives">18</b></span>
    </div>
    <div id="set-info">
        –°–ï–¢: <span id="progress">0</span> / 9 
        <div id="combo" class="combo-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>

    <div id="question-box">–ó–ê–ì–†–£–ó–ö–ê</div>
    
    <div id="timer-area">
        <div id="timer-container"><div id="timer-bar"></div></div>
    </div>

    <div id="grid">
        <button class="cell" onclick="makeMove(1)">1</button>
        <button class="cell" onclick="makeMove(2)">2</button>
        <button class="cell" onclick="makeMove(3)">3</button>
        <button class="cell" onclick="makeMove(4)">4</button>
        <button class="cell" onclick="makeMove(5)">5</button>
        <button class="cell" onclick="makeMove(6)">6</button>
        <button class="cell" onclick="makeMove(7)">7</button>
        <button class="cell" onclick="makeMove(8)">8</button>
        <button class="cell" onclick="makeMove(9)">9</button>
    </div>

    <div id="bonus-grid">
        <button class="cell comp-btn" onclick="makeBonusMove('<')">&lt;</button>
        <button class="cell comp-btn" onclick="makeBonusMove('=')">=</button>
        <button class="cell comp-btn" onclick="makeBonusMove('>')">&gt;</button>
    </div>

    <button id="start-btn" onclick="startNewSet()">–ù–ê–ß–ê–¢–¨ –°–ï–¢</button>
</div>

<script>
    let tokens = 0, lives = 18, setProgress = 0, combo = 0;
    let currentQuestionIndex = 0; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
    let currentAnswer, timer, canClick = false, isBonus = false, bonusStep = 0, bonusAnswer = '';
    let allQuestions = [];

    async function init() {
        try {
            const res = await fetch('questions.json?v=' + Date.now());
            allQuestions = await res.json();
            document.getElementById('question-box').innerText = "–ì–û–¢–û–í";
            document.getElementById('start-btn').style.display = 'block';
        } catch (e) { document.getElementById('question-box').innerText = "–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò"; }
    }

    function startNewSet() {
        setProgress = 0;
        lives = 18;
        combo = 0;
        isBonus = false;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('grid').style.display = 'grid';
        document.getElementById('bonus-grid').style.display = 'none';
        updateUI();
        nextQuestion();
    }

    function nextQuestion() {
        if (setProgress >= 9) { startBonusRound(); return; }
        
        canClick = false;
        resetStyles();
        
        // –ë–µ—Ä–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ –ø–æ—Ä—è–¥–∫—É –∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
        const q = allQuestions[currentQuestionIndex];
        currentAnswer = q.a;
        
        // –õ–∏–º–∏—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É: 3, 6, 9 —Å–µ–∫
        let timeLimit = q.t; // –ò—Å–ø–æ–ª—å–∑—É–µ–º t –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON

        document.getElementById('question-box').innerText = q.q;
        startTimer(timeLimit);
        setTimeout(() => { canClick = true; }, 200);
    }

    function makeMove(num) {
        if (!canClick) return;
        const cells = document.querySelectorAll('#grid .cell');
        
        if (num === currentAnswer) {
            clearInterval(timer);
            tokens += 10;
            combo++;
            setProgress++;
            
            if (combo === 3) { tokens += 30; combo = 0; }
            
            cells[num-1].classList.add('correct');
            
            currentQuestionIndex++;
            if (currentQuestionIndex >= allQuestions.length) currentQuestionIndex = 0;

            updateUI();
            setTimeout(nextQuestion, 500);
        } else {
            tokens = Math.max(0, tokens - 1);
            lives--;
            combo = 0;
            cells[num-1].classList.add('wrong');
            updateUI();
            if (lives <= 0) gameOver("–ñ–ò–ó–ù–ò –ö–û–ù–ß–ò–õ–ò–°–¨");
        }
    }

    function startBonusRound() {
        isBonus = true;
        bonusStep = 0;
        document.getElementById('grid').style.display = 'none';
        document.getElementById('bonus-grid').style.display = 'grid';
        nextBonusTask();
    }

    function nextBonusTask() {
        if (bonusStep >= 3) {
            tokens += 1000;
            updateUI();
            alert("–ë–û–ù–£–° 1000 –¢–û–ö–ï–ù–û–í –í–ê–®!");
            startNewSet();
            return;
        }
        
        // –ë–µ—Ä–µ–º –æ–¥–∏–Ω –ª–µ–≥–∫–∏–π –∏ –æ–¥–∏–Ω —Å–ª–æ–∂–Ω—ã–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        const q1 = allQuestions[Math.floor(Math.random() * 2000)]; 
        const q2 = allQuestions[allQuestions.length - 1 - Math.floor(random(0, 2000))];
        
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —á–µ—Ä–µ–∑ .a
        const v1 = q1.a;
        const v2 = (allQuestions[currentQuestionIndex + 8] || q1).a; // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ä–∞–Ω–¥–æ–º–Ω—ã–π —Å–ª–æ–∂–Ω—ã–π

        const qA = allQuestions[Math.floor(Math.random() * 500)]; // Easy
        const qB = allQuestions[allQuestions.length - 1 - Math.floor(Math.random() * 500)]; // Hard

        if (qA.a < qB.a) bonusAnswer = '<';
        else if (qA.a > qB.a) bonusAnswer = '>';
        else bonusAnswer = '=';

        document.getElementById('question-box').innerHTML = `
            <div style="font-size:16px; color:#00d2ff">–ë–û–ù–£–° ${bonusStep+1}/3</div>
            <div class="bonus-q">${qA.q} <span style="color:#e94560">?</span> ${qB.q}</div>
        `;
        startTimer(9000);
        canClick = true;
    }

    function makeBonusMove(sym) {
        if (!canClick) return;
        if (sym === bonusAnswer) {
            clearInterval(timer);
            bonusStep++;
            nextBonusTask();
        } else {
            alert("–û–®–ò–ë–ö–ê –í –ë–û–ù–£–°–ï!");
            startNewSet();
        }
    }

    function startTimer(duration) {
        clearInterval(timer);
        const bar = document.getElementById('timer-bar');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { bar.style.transition = `width ${duration}ms linear`; bar.style.width = '0%'; }, 50);
        timer = setTimeout(() => { 
            if(isBonus) gameOver("–í–†–ï–ú–Ø –í–´–®–õ–û");
            else { 
                lives--; updateUI(); 
                if(lives <= 0) gameOver("–í–†–ï–ú–Ø –í–´–®–õ–û"); else nextQuestion(); 
            }
        }, duration);
    }

    function updateUI() {
        document.getElementById('tokens').innerText = tokens;
        document.getElementById('lives').innerText = lives;
        document.getElementById('progress').innerText = setProgress;
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.className = i < combo ? 'dot active' : 'dot');
    }

    function gameOver(txt) {
        clearInterval(timer);
        canClick = false;
        document.getElementById('question-box').innerText = txt;
        document.getElementById('start-btn').style.display = 'block';
        document.getElementById('start-btn').innerText = "–ü–û–í–¢–û–†–ò–¢–¨ –°–ï–¢";
    }

    function resetStyles() {
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('correct', 'wrong'));
    }

    function random(min, max) { return Math.floor(Math.random(
    ) * (max - min + 1) + min); }

    init();
</script>
</body>
</html>

